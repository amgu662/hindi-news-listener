<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hindi News Listener</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon-512.png">
  <meta name="theme-color" content="#FF9933">

  <style>
    :root{
      --saffron:#FF9933;
      --green:#138808;
      --chakra:#000080;
      --ink:#111;
      --muted:#666;
      --card:#fff;
      --bg1:rgba(255,153,51,0.10);
      --bg2:rgba(255,255,255,0.35);
      --bg3:rgba(19,136,8,0.10);
    }
    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      margin: 0;
      color: var(--ink);
      background: linear-gradient(180deg, var(--bg1), var(--bg2), var(--bg3));
      min-height: 100vh;
    }
    header{
      padding: 14px 16px;
      background: #fff;
      border-top: 6px solid var(--saffron);
      border-bottom: 6px solid var(--green);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    header h2{
      margin: 0;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:right;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      color: var(--chakra);
    }
    main{ padding: 16px; }
    .top{ display:flex; gap:12px; flex-wrap: wrap; align-items:center; justify-content: flex-start; }

    .controlsBox{
      border:1px dashed #ddd;
      padding:10px;
      border-radius:12px;
      margin-top: 10px;
      max-width: 980px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content: flex-start; }

    .card{
      border:1px solid #e6e6e6;
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
      max-width: 980px;
      background: var(--card);
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      text-align:right;
    }

    /* NEXT/PREV ×‘×©×•×¨×” × ×¤×¨×“×ª */
    .navRow{
      margin-top: 10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }

    button{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #cfcfcf;
      background:#fff;
      cursor:pointer;
      transition: transform .03s ease, background .12s ease;
    }
    button:hover{ background:#f5f5f5; }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity: .55; cursor: not-allowed; }

    button.primary{
      background: var(--chakra);
      color:#fff;
      border-color: var(--chakra);
    }
    button.danger{
      background:#b00020;
      color:#fff;
      border-color:#b00020;
    }

    select, input{ padding:6px 10px; border-radius:10px; border:1px solid #cfcfcf; }
    .small{ color: var(--muted); font-size: 12px; }

    .title{
      font-weight: 700;
      font-size: 18px;
      margin: 6px 0 10px;
      direction: ltr;       /* ×× ×’×œ×™×ª LTR */
      text-align: right;    /* ××‘×œ ××™×•×©×¨ ×œ×™××™×Ÿ */
      unicode-bidi: plaintext;
    }

    /* ×”×™× ×“×™×ª ×”×™× LTR ××‘×œ ××™×•×©×¨×ª ×œ×™××™×Ÿ */
    .hi, .word{
      direction: ltr;
      unicode-bidi: plaintext;
      text-align: right;
    }
    .hi{
      font-size: 20px;
      margin: 8px 0 2px;
      padding: 6px 8px;
      border-radius: 12px;
      line-height: 1.7;
    }
    .he{ color:#333; margin: 0 0 10px; padding: 0 8px 6px; }

    .hi.activeSentence{ background: #fff3c4; border: 1px solid #f1d16a; }

    .word{
      display: inline-block;
      padding: 2px 6px;
      margin: 2px 2px;
      border-radius: 10px;
      cursor: pointer;
    }
    .word:hover{ background: #f0f0f0; }
    .word.activeWord{
      background: #cfe9ff;
      outline: 1px solid #8ec5ff;
    }

    .imgWrap{ margin-top: 10px; text-align: right; }
    .newsImg{ width: 260px; max-width: 100%; border-radius: 12px; display: inline-block; border:1px solid #eee; }

    .pill{ border:1px solid #e9e9e9; border-radius:999px; padding:6px 10px; background:#fff; }

    /* Tooltip ×œ×ª×¨×’×•× ××¢×œ ××™×œ×” */
    #wordTip{
      position: fixed;
      display: none;
      z-index: 9999;
      background: #111;
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
      max-width: 260px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      transform: translate(-50%, -110%);
      pointer-events: none;
      white-space: nowrap;
    }

    .currentWordLine{
      margin-top: 8px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.85);
      border: 1px solid #eee;
      max-width: 980px;
      text-align:right;
    }

    .hr{
      height:1px;
      background: linear-gradient(90deg, var(--saffron), #fff, var(--green));
      border:0;
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <header>
    <h2>
      Hindi News Listener
      <span class="badge">ğŸ‡®ğŸ‡³ à¤­à¤¾à¤°à¤¤</span>
    </h2>
  </header>

  <main>
    <div class="top">
      <label>×›××•×ª ×™×“×™×¢×•×ª:
        <input id="count" type="number" min="1" max="10" value="2" />
      </label>

      <label>×—×™×¤×•×© (q):
        <input id="q" type="text" value="India" />
      </label>

      <label>×¨××ª ×”×™× ×“×™×ª:
        <select id="level">
          <option value="beginner">××ª×—×™×œ×™×</option>
          <option value="intermediate">×‘×™× ×•× ×™×™×</option>
          <option value="advanced">××ª×§×“××™×</option>
        </select>
      </label>

      <button id="load" class="primary">Load news</button>
      <span class="small" id="status"></span>
    </div>

    <div class="controlsBox">
      <div class="row">
        <label>×§×¦×‘ ×“×™×‘×•×¨ (%):
          <input id="rate" type="range" min="60" max="140" value="100" />
        </label>
        <span class="small" id="rateVal">100%</span>

        <label>×¤××•×–×” ×‘×™×Ÿ ××™×œ×™×:
          <select id="pause">
            <option value="0">0</option>
            <option value="500">0.5 ×©× ×³</option>
            <option value="1000">1 ×©× ×³</option>
            <option value="1500">1.5 ×©× ×³</option>
            <option value="2000">2 ×©× ×³</option>
          </select>
        </label>

        <label>××¦×‘ ××¢×‘×¨ ××©×¤×˜×™×:
          <select id="mode">
            <option value="auto">××•×˜×•××˜×™</option>
            <option value="space">×¢× ×¨×•×•×— (Space)</option>
          </select>
        </label>

        <span class="pill small">×‘××¦×‘ Space: ×¨×•×•×— = ××©×¤×˜ ×”×‘× | R = Repeat | â†/â†’ = Prev/Next</span>
      </div>
    </div>

    <div class="currentWordLine small" id="currentWordLine">
      ××™×œ×” × ×•×›×—×™×ª: <b id="cw_hi">â€”</b> | ×ª×¨×’×•×: <b id="cw_he">â€”</b>
    </div>

    <div id="list"></div>
    <div id="wordTip"></div>
  </main>

<script>
const $ = (id) => document.getElementById(id);

let currentAudio = null;
let activeSession = null;

$("rate").addEventListener("input", () => {
  $("rateVal").textContent = `${$("rate").value}%`;
});

function splitHindiHebrew(text) {
  const lines = text.split("\n").map(s => s.trim()).filter(Boolean);
  const pairs = [];
  for (let i = 0; i < lines.length; i += 2) {
    pairs.push({ hi: lines[i] ?? "", he: lines[i + 1] ?? "" });
  }
  return pairs;
}

async function apiGet(url) {
  const r = await fetch(url);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiPostJson(url, body) {
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiPostAudio(url, body) {
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const ct = (r.headers.get("content-type") || "").toLowerCase();
  if (!r.ok || ct.includes("application/json") || ct.includes("text/")) {
    const txt = await r.text();
    throw new Error(txt);
  }

  const buf = await r.arrayBuffer();
  if (!buf || buf.byteLength < 150) throw new Error("Audio too small");
  return buf;
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

function stopAudio() {
  if (currentAudio) {
    try { currentAudio.pause(); } catch {}
    currentAudio = null;
  }
  if (activeSession) activeSession.token++;
}

function clearSentenceHighlight(session) {
  session.hiSentenceEls.forEach(el => el.classList.remove("activeSentence"));
}

function setSentenceHighlight(session, idx) {
  clearSentenceHighlight(session);
  const el = session.hiSentenceEls[idx];
  if (el) el.classList.add("activeSentence");
}

function clearWordHighlight(session) {
  const arr = session.wordSpanElsBySentence[session.idx] || [];
  arr.forEach(s => s.classList.remove("activeWord"));
}

function setWordHighlight(session, wordIndex) {
  const arr = session.wordSpanElsBySentence[session.idx] || [];
  arr.forEach(s => s.classList.remove("activeWord"));
  const el = arr[wordIndex];
  if (el) el.classList.add("activeWord");
  return el || null;
}

function showTipOver(el, text) {
  const tip = $("wordTip");
  if (!el) { tip.style.display = "none"; return; }
  const r = el.getBoundingClientRect();
  tip.textContent = text || "";
  tip.style.left = `${r.left + r.width / 2}px`;
  tip.style.top = `${r.top}px`;
  tip.style.display = text ? "block" : "none";
}

function setCurrentWordLine(hi, he) {
  $("cw_hi").textContent = hi || "â€”";
  $("cw_he").textContent = he || "â€”";
}

async function ensureWordMap(session, sentenceIdx) {
  if (session.wordMaps[sentenceIdx]) return session.wordMaps[sentenceIdx];
  const sentence = session.sentences[sentenceIdx] || "";
  const resp = await apiPostJson("/api/wordmap", { sentence });
  const map = Array.isArray(resp.words) ? resp.words : [];
  session.wordMaps[sentenceIdx] = map;
  return map;
}

// --- Prefetch to remove long gaps when pause=0 ---
async function fetchWordAudioBlob(wordText) {
  const rate = Number($("rate").value || 100);
  const audioBuf = await apiPostAudio("/api/speak", { text: wordText, rate, pauseMs: 0 });
  return new Blob([audioBuf], { type: "audio/mpeg" });
}

async function playBlob(blob) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(blob);
    const a = new Audio(url);
    currentAudio = a;

    a.onended = () => {
      URL.revokeObjectURL(url);
      if (currentAudio === a) currentAudio = null;
      resolve();
    };
    a.onerror = () => {
      URL.revokeObjectURL(url);
      if (currentAudio === a) currentAudio = null;
      reject(new Error("Audio play failed"));
    };

    a.play().catch(err => {
      URL.revokeObjectURL(url);
      if (currentAudio === a) currentAudio = null;
      reject(err);
    });
  });
}

async function playWord(session, wordText, prefetchedBlob) {
  const blob = prefetchedBlob || await fetchWordAudioBlob(wordText);
  await playBlob(blob);
}

async function playSentenceWordByWord(session, sentenceIdx) {
  session.idx = sentenceIdx;
  setSentenceHighlight(session, sentenceIdx);

  const tokenAtStart = session.token;

  const pauseMs = Number($("pause").value || 0);
  const words = session.wordsBySentence[sentenceIdx] || [];
  if (!words.length) return;

  const wordMap = await ensureWordMap(session, sentenceIdx);

  // prefetch first
  let nextAudioPromise = fetchWordAudioBlob(words[0]);

  for (let i = 0; i < words.length; i++) {
    if (session.token !== tokenAtStart) return;

    const w = words[i];
    const he = (wordMap[i] && wordMap[i].he) ? wordMap[i].he : "";

    const spanEl = setWordHighlight(session, i);
    setCurrentWordLine(w, he);
    showTipOver(spanEl, he);

    const currentBlob = await nextAudioPromise;

    const nextWord = words[i + 1];
    nextAudioPromise = nextWord ? fetchWordAudioBlob(nextWord) : Promise.resolve(null);

    await playWord(session, w, currentBlob);

    showTipOver(null, "");
    if (pauseMs > 0) await sleep(pauseMs);
  }

  clearWordHighlight(session);
  setCurrentWordLine("", "");
}

function nextSentence(session) {
  const next = session.idx + 1;
  if (next < session.sentences.length) {
    playFlow(session, next).catch(e => alert("×©×’×™××”: " + e.message));
  } else {
    clearSentenceHighlight(session);
    setCurrentWordLine("", "");
  }
}

function prevSentence(session) {
  const prev = session.idx - 1;
  if (prev >= 0) playFlow(session, prev).catch(e => alert("×©×’×™××”: " + e.message));
}

function repeatSentence(session) {
  playFlow(session, session.idx).catch(e => alert("×©×’×™××”: " + e.message));
}

async function playFlow(session, startIdx) {
  const mode = $("mode").value;

  if (mode === "auto") {
    for (let s = startIdx; s < session.sentences.length; s++) {
      const token = session.token;
      await playSentenceWordByWord(session, s);
      if (session.token !== token) return;
    }
    clearSentenceHighlight(session);
  } else {
    await playSentenceWordByWord(session, startIdx);
  }
}

// Shortcuts
document.addEventListener("keydown", (ev) => {
  const tag = (ev.target && ev.target.tagName || "").toLowerCase();
  if (tag === "input" || tag === "textarea" || tag === "select") return;
  if (!activeSession) return;

  if ($("mode").value === "space") {
    if (ev.code === "Space") { ev.preventDefault(); nextSentence(activeSession); }
    if (ev.key === "r" || ev.key === "R") { ev.preventDefault(); repeatSentence(activeSession); }
    if (ev.key === "ArrowRight") { ev.preventDefault(); nextSentence(activeSession); }
    if (ev.key === "ArrowLeft") { ev.preventDefault(); prevSentence(activeSession); }
  }
});

async function summarizeInto(outEl, article, level) {
  outEl.innerHTML = `<div class="small">××¡×›×â€¦</div>`;

  const raw = `${article.title || ""}\n\n${article.description || ""}\n\n${article.content || ""}`.trim();
  const s = await apiPostJson("/api/summarize", { text: raw, level });

  const pairs = splitHindiHebrew(s.result);
  const sentences = pairs.map(p => p.hi).filter(Boolean);

  outEl.innerHTML = "";
  const hiSentenceEls = [];
  const wordSpanElsBySentence = [];
  const wordsBySentence = [];

  for (let si = 0; si < pairs.length; si++) {
    const p = pairs[si];

    const hi = document.createElement("div");
    hi.className = "hi";

    const words = String(p.hi || "").trim().split(/\s+/).filter(Boolean);
    wordsBySentence.push(words);

    const spans = [];
    for (const w of words) {
      const sp = document.createElement("span");
      sp.className = "word";
      sp.textContent = w;
      sp.title = "×œ×—×¥ ×›×“×™ ×œ×©××•×¢ ××ª ×”××™×œ×”";

      sp.addEventListener("click", async () => {
        try {
          stopAudio();

          let he = "";
          if (activeSession) {
            const map = await ensureWordMap(activeSession, activeSession.idx);
            const arr = activeSession.wordSpanElsBySentence[activeSession.idx] || [];
            const idx = arr.indexOf(sp);
            if (idx >= 0 && map[idx] && map[idx].he) he = map[idx].he;
          }

          setCurrentWordLine(w, he);
          showTipOver(sp, he);

          const blob = await fetchWordAudioBlob(w);
          await playBlob(blob);

          showTipOver(null, "");
        } catch (e) {
          alert("×©×’×™××”: " + e.message);
        }
      });

      hi.appendChild(sp);
      spans.push(sp);
      hi.appendChild(document.createTextNode(" "));
    }

    wordSpanElsBySentence.push(spans);
    hiSentenceEls.push(hi);

    const he = document.createElement("div");
    he.className = "he";
    he.textContent = p.he;

    outEl.appendChild(hi);
    outEl.appendChild(he);
  }

  return { sentences, hiSentenceEls, wordSpanElsBySentence, wordsBySentence };
}

// 3) Don't show already-seen articles (device-local)
function getSeen() {
  try { return new Set(JSON.parse(localStorage.getItem("seenUrls") || "[]")); }
  catch { return new Set(); }
}
function saveSeen(set) {
  localStorage.setItem("seenUrls", JSON.stringify([...set]));
}

async function loadNews() {
  $("status").textContent = "×˜×•×¢×Ÿ ×—×“×©×•×ª...";
  $("list").innerHTML = "";
  activeSession = null;
  stopAudio();

  const count = Number($("count").value || 2);
  const q = $("q").value || "India";
  const level = $("level").value;

  const news = await apiGet(`/api/news?count=${encodeURIComponent(count)}&q=${encodeURIComponent(q)}`);

  const seen = getSeen();
  const unique = (news.articles || []).filter(a => a?.url && !seen.has(a.url));
  const chosen = unique.slice(0, count);

  chosen.forEach(a => seen.add(a.url));
  saveSeen(seen);

  $("status").textContent = `××¦×™×’ ${chosen.length} (×—×“×©×•×ª ×—×“×©×•×ª ×‘×œ×‘×“).`;

  for (const a of chosen) {
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = a.title || "(no title)";

    const controls = document.createElement("div");
    controls.className = "row";

    const readBtn = document.createElement("button");
    readBtn.textContent = "READ";
    readBtn.className = "primary";
    controls.appendChild(readBtn);

    const repeatBtn = document.createElement("button");
    repeatBtn.textContent = "REPEAT";
    controls.appendChild(repeatBtn);

    const stopBtn = document.createElement("button");
    stopBtn.textContent = "STOP";
    stopBtn.className = "danger";
    controls.appendChild(stopBtn);

    const info = document.createElement("span");
    info.className = "small";
    controls.appendChild(info);

    // 4) NEXT/PREV row
    const nav = document.createElement("div");
    nav.className = "navRow";

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "PREV";
    nav.appendChild(prevBtn);

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "NEXT";
    nav.appendChild(nextBtn);

    const out = document.createElement("div");

    const imgWrap = document.createElement("div");
    imgWrap.className = "imgWrap";
    const img = document.createElement("img");
    img.className = "newsImg";
    img.src = a.urlToImage || "";
    img.alt = "news image";
    if (!a.urlToImage) img.style.display = "none";
    imgWrap.appendChild(img);

    card.appendChild(title);
    card.appendChild(controls);
    card.appendChild(nav);
    const hr = document.createElement("hr");
    hr.className = "hr";
    card.appendChild(hr);
    card.appendChild(out);
    card.appendChild(imgWrap);
    $("list").appendChild(card);

    let summaryData = null;

    summarizeInto(out, a, level)
      .then(d => {
        summaryData = d;
        info.textContent = `(${d.sentences.length} ××©×¤×˜×™×)`;
      })
      .catch(e => {
        out.innerHTML = `<div class="small">×©×’×™××” ×‘×¡×™×›×•×: ${e.message}</div>`;
      });

    stopBtn.onclick = () => {
      stopAudio();
      if (activeSession && activeSession.readBtnEl) {
        activeSession.readBtnEl.disabled = false;
        activeSession.readBtnEl.textContent = "READ";
      }
      activeSession = null;
      $("wordTip").style.display = "none";
      setCurrentWordLine("", "");
    };

    nextBtn.onclick = () => {
      if (!activeSession || activeSession.outEl !== out) return alert("×”×¤×¢×œ READ ×§×•×“× ×›×“×™ ×œ×”×ª×—×™×œ.");
      nextSentence(activeSession);
    };

    prevBtn.onclick = () => {
      if (!activeSession || activeSession.outEl !== out) return alert("×”×¤×¢×œ READ ×§×•×“× ×›×“×™ ×œ×”×ª×—×™×œ.");
      prevSentence(activeSession);
    };

    repeatBtn.onclick = () => {
      if (!activeSession || activeSession.outEl !== out) return alert("×”×¤×¢×œ READ ×§×•×“× ×›×“×™ ×œ×”×ª×—×™×œ.");
      repeatSentence(activeSession);
    };

    readBtn.onclick = async () => {
      try {
        if (!summaryData) return alert("×”×¡×™×›×•× ×¢×“×™×™×Ÿ × ×˜×¢×Ÿâ€¦ × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢.");
        if (!summaryData.sentences.length) return alert("××™×Ÿ ××©×¤×˜×™× ×œ×”×§×¨××”.");

        stopAudio();

        const session = {
          outEl: out,
          readBtnEl: readBtn,
          sentences: summaryData.sentences,
          hiSentenceEls: summaryData.hiSentenceEls,
          wordSpanElsBySentence: summaryData.wordSpanElsBySentence,
          wordsBySentence: summaryData.wordsBySentence,
          wordMaps: {},
          idx: 0,
          token: 0
        };
        activeSession = session;

        readBtn.disabled = true;
        readBtn.textContent = "READING...";

        await playFlow(session, 0);

      } catch (e) {
        alert("×©×’×™××”: " + e.message);
      } finally {
        readBtn.disabled = false;
        readBtn.textContent = "READ";
      }
    };
  }

  if ((news.articles || []).length && chosen.length === 0) {
    $("status").textContent = "××™×Ÿ ×—×“×©×•×ª ×—×“×©×•×ª ×œ×”×¦×’×” (×›×‘×¨ ×¨××™×ª ××ª ×›×•×œ×Ÿ).";
  }
}

$("load").onclick = () => loadNews().catch(e => {
  $("status").textContent = "×©×’×™××”: " + e.message;
});
</script>
</body>
</html>
